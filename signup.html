<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timetable Planner - Create Account</title>

    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#2c5f4f" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Timetable" />

    <!-- Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Work+Sans:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Stylesheet -->
    <link rel="stylesheet" href="css/styles.css" />

    <!-- AWS Configuration -->
    <script src="js/aws-config.js"></script>
    <script src="js/aws-auth.js"></script>

    <!-- Signup page specific styles -->
    <style>
      body {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      }

      .password-requirements {
        font-size: 0.8rem;
        color: var(--text-light);
        margin-top: 0.5rem;
      }

      .password-requirements ul {
        margin: 0.5rem 0 0 1.2rem;
        padding: 0;
      }

      .password-requirements li {
        margin-bottom: 0.25rem;
      }

      .step-indicator {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
      }

      .step-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--border);
        transition: background 0.3s;
      }

      .step-dot.active {
        background: var(--primary);
      }

      .verification-code-input {
        text-align: center;
        font-size: 1.5rem;
        letter-spacing: 0.5rem;
        font-family: monospace;
      }

      .resend-link {
        text-align: center;
        margin-top: 1rem;
        font-size: 0.9rem;
      }

      .resend-link a {
        color: var(--primary);
        cursor: pointer;
        text-decoration: underline;
      }

      .resend-link a:hover {
        color: var(--primary-dark);
      }

      .success-message {
        text-align: center;
        padding: 2rem;
      }

      .success-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="login-container">
      <h1 class="login-title">Create Account</h1>
      <p class="login-subtitle">Set up your timetable system</p>

      <!-- Step Indicator -->
      <div class="step-indicator">
        <div class="step-dot active" id="step1Dot"></div>
        <div class="step-dot" id="step2Dot"></div>
      </div>

      <div class="login-error" id="signupError"></div>

      <!-- Step 1: Registration Form -->
      <div id="registrationForm" class="login-form active">
        <div class="form-group">
          <label for="emailInput">Email</label>
          <input
            type="email"
            id="emailInput"
            class="login-input"
            placeholder="Enter your email"
            autocomplete="email"
          />
        </div>

        <div class="form-group">
          <label for="passwordInput">Password</label>
          <input
            type="password"
            id="passwordInput"
            class="login-input"
            placeholder="Create a password"
            autocomplete="new-password"
          />
          <div class="password-requirements">
            Password must contain:
            <ul>
              <li>At least 8 characters</li>
              <li>Uppercase and lowercase letters</li>
              <li>At least one number</li>
              <li>At least one special character (!@#$%^&*)</li>
            </ul>
          </div>
        </div>

        <div class="form-group">
          <label for="confirmPasswordInput">Confirm Password</label>
          <input
            type="password"
            id="confirmPasswordInput"
            class="login-input"
            placeholder="Confirm your password"
            autocomplete="new-password"
          />
        </div>

        <button class="login-button" onclick="handleSignup()" id="signupButton">
          Create Account
        </button>

        <div class="login-divider">
          <span>or</span>
        </div>

        <button class="login-button secondary" onclick="window.location.href='index.html'">
          Back to Login
        </button>
      </div>

      <!-- Step 2: Email Verification -->
      <div id="verificationForm" class="login-form" style="display: none;">
        <p style="text-align: center; margin-bottom: 1.5rem;">
          We've sent a verification code to<br>
          <strong id="verificationEmail"></strong>
        </p>

        <div class="form-group">
          <label for="verificationCode">Verification Code</label>
          <input
            type="text"
            id="verificationCode"
            class="login-input verification-code-input"
            placeholder="000000"
            maxlength="6"
            autocomplete="one-time-code"
          />
        </div>

        <button class="login-button" onclick="handleVerification()" id="verifyButton">
          Verify Email
        </button>

        <div class="resend-link">
          Didn't receive the code? <a onclick="handleResendCode()">Resend</a>
        </div>
      </div>

      <!-- Step 3: Success -->
      <div id="successMessage" class="login-form" style="display: none;">
        <div class="success-message">
          <div class="success-icon">&#10003;</div>
          <h2>Account Created!</h2>
          <p>Your account has been verified successfully.</p>
          <p>Redirecting to setup...</p>
        </div>
      </div>
    </div>

    <script>
      // Store email for verification step
      let signupEmail = '';

      // Check if already logged in
      document.addEventListener("DOMContentLoaded", function() {
        if (isAuthenticated()) {
          window.location.href = 'admin.html';
          return;
        }

        // Setup Enter key handlers
        document.getElementById("emailInput").addEventListener("keypress", function(e) {
          if (e.key === "Enter") {
            document.getElementById("passwordInput").focus();
          }
        });

        document.getElementById("passwordInput").addEventListener("keypress", function(e) {
          if (e.key === "Enter") {
            document.getElementById("confirmPasswordInput").focus();
          }
        });

        document.getElementById("confirmPasswordInput").addEventListener("keypress", function(e) {
          if (e.key === "Enter") {
            handleSignup();
          }
        });

        document.getElementById("verificationCode").addEventListener("keypress", function(e) {
          if (e.key === "Enter") {
            handleVerification();
          }
        });
      });

      /**
       * Handle signup form submission
       */
      async function handleSignup() {
        const email = document.getElementById("emailInput").value.trim();
        const password = document.getElementById("passwordInput").value;
        const confirmPassword = document.getElementById("confirmPasswordInput").value;
        const signupButton = document.getElementById("signupButton");

        // Validation
        if (!email || !password || !confirmPassword) {
          showError("Please fill in all fields");
          return;
        }

        if (!email.includes('@')) {
          showError("Please enter a valid email address");
          return;
        }

        if (password !== confirmPassword) {
          showError("Passwords do not match");
          return;
        }

        if (password.length < 8) {
          showError("Password must be at least 8 characters");
          return;
        }

        // Basic password strength check
        const hasUpper = /[A-Z]/.test(password);
        const hasLower = /[a-z]/.test(password);
        const hasNumber = /[0-9]/.test(password);
        const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);

        if (!hasUpper || !hasLower || !hasNumber || !hasSpecial) {
          showError("Password does not meet requirements");
          return;
        }

        try {
          // Show loading state
          signupButton.disabled = true;
          signupButton.textContent = "Creating account...";
          hideError();

          // Call Cognito SignUp
          await cognitoSignUp(email, password);

          // Store email for verification
          signupEmail = email;

          // Show verification form
          showVerificationStep();

        } catch (error) {
          console.error("Signup error:", error);
          showError(error.message || "Signup failed. Please try again.");
          signupButton.disabled = false;
          signupButton.textContent = "Create Account";
        }
      }

      /**
       * Handle email verification
       */
      async function handleVerification() {
        const code = document.getElementById("verificationCode").value.trim();
        const verifyButton = document.getElementById("verifyButton");

        if (!code || code.length !== 6) {
          showError("Please enter the 6-digit verification code");
          return;
        }

        try {
          verifyButton.disabled = true;
          verifyButton.textContent = "Verifying...";
          hideError();

          // Confirm signup with verification code
          await cognitoConfirmSignUp(signupEmail, code);

          // Show success and redirect
          showSuccessStep();

          // Auto-login and redirect to setup after 2 seconds
          setTimeout(async () => {
            try {
              // Get password from the form (still in DOM)
              const password = document.getElementById("passwordInput").value;
              await cognitoLogin(signupEmail, password);
              window.location.href = 'setup.html';
            } catch (loginError) {
              console.error("Auto-login failed:", loginError);
              window.location.href = 'index.html';
            }
          }, 2000);

        } catch (error) {
          console.error("Verification error:", error);
          showError(error.message || "Verification failed. Please try again.");
          verifyButton.disabled = false;
          verifyButton.textContent = "Verify Email";
        }
      }

      /**
       * Handle resend verification code
       */
      async function handleResendCode() {
        try {
          hideError();
          await cognitoResendCode(signupEmail);
          showError("Verification code resent! Check your email.");
          document.getElementById("signupError").style.background = "#efe";
          document.getElementById("signupError").style.borderColor = "#cfc";
          document.getElementById("signupError").style.color = "#060";
        } catch (error) {
          console.error("Resend error:", error);
          showError(error.message || "Failed to resend code");
        }
      }

      /**
       * Show verification step
       */
      function showVerificationStep() {
        document.getElementById("registrationForm").style.display = "none";
        document.getElementById("verificationForm").style.display = "block";
        document.getElementById("verificationEmail").textContent = signupEmail;
        document.getElementById("step1Dot").classList.remove("active");
        document.getElementById("step2Dot").classList.add("active");
        document.getElementById("verificationCode").focus();
      }

      /**
       * Show success step
       */
      function showSuccessStep() {
        document.getElementById("verificationForm").style.display = "none";
        document.getElementById("successMessage").style.display = "block";
        document.getElementById("step2Dot").classList.add("active");
      }

      /**
       * Show error message
       */
      function showError(message) {
        const errorDiv = document.getElementById("signupError");
        errorDiv.textContent = message;
        errorDiv.classList.add("active");
        // Reset styles in case they were changed for success message
        errorDiv.style.background = "#fee";
        errorDiv.style.borderColor = "#fcc";
        errorDiv.style.color = "#c00";
      }

      /**
       * Hide error message
       */
      function hideError() {
        document.getElementById("signupError").classList.remove("active");
      }
    </script>
  </body>
</html>
