<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timetable Planner - Login</title>

    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#2c5f4f" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Timetable" />

    <!-- Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=Work+Sans:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- Stylesheet -->
    <link rel="stylesheet" href="css/styles.css" />

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- Login page specific styles -->
    <style>
      body {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      }
    </style>
  </head>
  <body>
    <div class="login-container">
      <h1 class="login-title">Timetable Planner</h1>
      <p class="login-subtitle">Flexible Scheduling for Schools</p>

      <div class="login-error" id="loginError"></div>

      <!-- Role Selection -->
      <div id="roleSelection" class="role-options">
        <div class="role-card" onclick="selectRole('eso')">
          <div class="role-icon">ðŸ‘¥</div>
          <div class="role-title">ESO Staff</div>
          <div class="role-description">View timetables and schedules</div>
        </div>

        <div class="role-card" onclick="selectRole('admin')">
          <div class="role-icon">ðŸ”‘</div>
          <div class="role-title">Leadership</div>
          <div class="role-description">Full access to edit and manage</div>
        </div>
      </div>

      <!-- Login Form -->
      <div id="loginForm" class="login-form">
        <h3 style="margin-bottom: 1.5rem; color: var(--primary); text-align: center" id="loginFormTitle">
          Login
        </h3>

        <input
          type="email"
          id="emailInput"
          class="login-input"
          placeholder="Email"
          autocomplete="email"
        />
        <input
          type="password"
          id="passwordInput"
          class="login-input"
          placeholder="Password"
          autocomplete="current-password"
        />

        <button class="login-button" onclick="handleLogin()" id="loginButton">
          Login
        </button>

        <button class="login-button back-button" onclick="backToRoleSelection()">
          Back
        </button>
      </div>
    </div>

    <!-- Shared utilities -->
    <script src="js/shared.js"></script>

    <script>
      let selectedRole = null;

      // Admin whitelist
      const ADMIN_EMAILS = [
        "cfrasca@whitefriars.catholic.edu.au",
        "mfrasca@whitefriars.catholic.edu.au",
        "leadership@yourschool.com",
      ];

      function selectRole(role) {
        selectedRole = role;
        document.getElementById("roleSelection").style.display = "none";
        document.getElementById("loginForm").classList.add("active");

        if (role === "eso") {
          document.getElementById("loginFormTitle").textContent = "Login as ESO Staff";
          document.getElementById("emailInput").value = "eso@yourschool.com";
          document.getElementById("passwordInput").value = "";
          document.getElementById("passwordInput").placeholder = "Enter ESO password";
        } else {
          document.getElementById("loginFormTitle").textContent = "Login as Leadership";
          document.getElementById("emailInput").value = "admin@yourschool.com";
          document.getElementById("passwordInput").value = "";
          document.getElementById("passwordInput").placeholder = "Enter admin password";
        }

        document.getElementById("passwordInput").focus();
      }

      function backToRoleSelection() {
        selectedRole = null;
        document.getElementById("roleSelection").style.display = "grid";
        document.getElementById("loginForm").classList.remove("active");
        document.getElementById("loginError").classList.remove("active");
        document.getElementById("emailInput").value = "";
        document.getElementById("passwordInput").value = "";
      }

      async function handleLogin() {
        const email = document.getElementById("emailInput").value.trim();
        const password = document.getElementById("passwordInput").value;
        const loginButton = document.getElementById("loginButton");
        const errorDiv = document.getElementById("loginError");

        if (!email || !password) {
          showLoginError("Please enter both email and password");
          return;
        }

        try {
          loginButton.disabled = true;
          loginButton.textContent = "Logging in...";
          errorDiv.classList.remove("active");

          const userCredential = await auth.signInWithEmailAndPassword(email, password);
          const user = userCredential.user;

          let userRole;
          if (ADMIN_EMAILS.includes(email.toLowerCase())) {
            userRole = "admin";
            console.log("Admin access granted to:", email);
          } else {
            userRole = "viewer";
            console.log("Viewer access granted to:", email);
          }

          sessionStorage.setItem("userRole", userRole);
          sessionStorage.setItem("userEmail", email);
          sessionStorage.setItem("userId", user.uid);

          if (userRole === "admin") {
            window.location.href = "admin.html";
          } else {
            window.location.href = "view.html";
          }
        } catch (error) {
          console.error("Login error:", error);
          let errorMessage = "Login failed. Please check your credentials.";

          if (error.code === "auth/wrong-password") {
            errorMessage = "Incorrect password. Please try again.";
          } else if (error.code === "auth/user-not-found") {
            errorMessage = "User not found. Please contact your administrator.";
          } else if (error.code === "auth/invalid-email") {
            errorMessage = "Invalid email address.";
          }

          showLoginError(errorMessage);
          loginButton.disabled = false;
          loginButton.textContent = "Login";
        }
      }

      function showLoginError(message) {
        const errorDiv = document.getElementById("loginError");
        errorDiv.textContent = message;
        errorDiv.classList.add("active");
      }

      document.addEventListener("DOMContentLoaded", function () {
        const passwordInput = document.getElementById("passwordInput");
        if (passwordInput) {
          passwordInput.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              handleLogin();
            }
          });
        }

        const userRole = sessionStorage.getItem("userRole");
        if (userRole) {
          auth.onAuthStateChanged((user) => {
            if (user) {
              if (userRole === "admin") {
                window.location.href = "admin.html";
              } else {
                window.location.href = "view.html";
              }
            }
          });
        }
      });
    </script>
  </body>
</html>
